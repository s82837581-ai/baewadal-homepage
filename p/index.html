/* =====================================================================
   MODIT â€“ Public Price Viewer + Report System (script.js)
   Author: Baewadal Co., Ltd.
   ===================================================================== */

document.addEventListener('DOMContentLoaded', () => {
  console.log("âœ… DOM ë¡œë“œ ì™„ë£Œ â€” ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì‹œì‘");

  /* ======================
     í™˜ê²½ ë³€ìˆ˜
     ====================== */
  const API_BASE = "https://bauvetkqpvkaoybhcoqj.supabase.co/functions/v1/make-server-f49b8637/v2";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhdXZldGtxcHZrYW95Ymhjb3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI2MjA2MTQsImV4cCI6MjA0ODE5NjYxNH0.qVCJ5xSxkN4yMXxX0X59_z8vAVlBSHmUhcU83tpImCQ";

  let currentLanguage = 'ko';
  let priceListData = null;
  let selectedReportType = null;

  /* ======================
     ë²ˆì—­
     ====================== */
  const TRANSLATIONS = {
    ko: {
      welcome: 'ì „í†µì‹œì¥ì— ì™€ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤',
      title: 'ê°€ê²©í‘œ',
      price: 'ê°€ê²©',
      unit: 'ë‹¨ìœ„',
      description: 'ì„¤ëª…',
      viewCount: 'ì¡°íšŒìˆ˜',
      lastUpdated: 'ìµœì¢… ì—…ë°ì´íŠ¸',
      reportBtn: 'ğŸš¨ ì œë³´í•˜ê¸°',
      modalTitle: 'ğŸš¨ ìš´ì˜ ë¶ˆí¸ ì œë³´í•˜ê¸°',
      reportTypeLabel: 'ì œë³´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš” *',
      descriptionLabel: 'ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš” *',
      anonymousLabel: 'ìµëª…ìœ¼ë¡œ ì œë³´í•˜ê¸°',
      nameLabel: 'ì œë³´ìëª…',
      contactLabel: 'ì—°ë½ì²˜',
      submitBtn: 'ì œë³´í•˜ê¸°',
      typePriceDisplay: 'ê°€ê²©Â·í‘œì‹œ ê´€ë ¨',
      typeProductQuality: 'ì œí’ˆÂ·í’ˆì§ˆ ê´€ë ¨',
      typeHygieneSafety: 'ìœ„ìƒÂ·ì•ˆì „ ê´€ë ¨',
      typeServiceResponse: 'ì„œë¹„ìŠ¤Â·ì‘ëŒ€ ê´€ë ¨',
      typePaymentReceipt: 'ê²°ì œÂ·ì˜ìˆ˜ì¦ ê´€ë ¨',
      typeIllegalHarmful: 'ë¶ˆë²•Â·ìœ í•´ í–‰ìœ„ ê´€ë ¨',
      typeFacilityEnvironment: 'ì‹œì„¤Â·í™˜ê²½ ê´€ë ¨',
      typeOther: 'ê¸°íƒ€',
      noItems: 'ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.'
    },
    en: {
      welcome: 'Thank you for visiting the traditional market',
      title: 'Price List',
      price: 'Price',
      unit: 'Unit',
      description: 'Description',
      viewCount: 'Views',
      lastUpdated: 'Last Updated',
      reportBtn: 'ğŸš¨ Report',
      modalTitle: 'ğŸš¨ Report Issue',
      reportTypeLabel: 'Select report type *',
      descriptionLabel: 'Please describe the situation *',
      anonymousLabel: 'Report anonymously',
      nameLabel: 'Your name',
      contactLabel: 'Contact',
      submitBtn: 'Submit',
      typePriceDisplay: 'Price/Display',
      typeProductQuality: 'Product/Quality',
      typeHygieneSafety: 'Hygiene/Safety',
      typeServiceResponse: 'Service/Response',
      typePaymentReceipt: 'Payment/Receipt',
      typeIllegalHarmful: 'Illegal/Harmful',
      typeFacilityEnvironment: 'Facility/Environment',
      typeOther: 'Other',
      noItems: 'No items registered.'
    },
    zh: {
      welcome: 'æ„Ÿè°¢æ‚¨è®¿é—®ä¼ ç»Ÿå¸‚åœº',
      title: 'ä»·æ ¼è¡¨',
      price: 'ä»·æ ¼',
      unit: 'å•ä½',
      description: 'è¯´æ˜',
      viewCount: 'æµè§ˆæ¬¡æ•°',
      lastUpdated: 'æœ€åæ›´æ–°',
      reportBtn: 'ğŸš¨ ä¸¾æŠ¥',
      modalTitle: 'ğŸš¨ ä¸¾æŠ¥é—®é¢˜',
      reportTypeLabel: 'è¯·é€‰æ‹©ä¸¾æŠ¥ç±»å‹ *',
      descriptionLabel: 'è¯·è¯¦ç»†è¯´æ˜æƒ…å†µ *',
      anonymousLabel: 'åŒ¿åä¸¾æŠ¥',
      nameLabel: 'æ‚¨çš„å§“å',
      contactLabel: 'è”ç³»æ–¹å¼',
      submitBtn: 'æäº¤',
      typePriceDisplay: 'ä»·æ ¼Â·æ ‡ç¤º',
      typeProductQuality: 'äº§å“Â·è´¨é‡',
      typeHygieneSafety: 'å«ç”ŸÂ·å®‰å…¨',
      typeServiceResponse: 'æœåŠ¡Â·åº”å¯¹',
      typePaymentReceipt: 'ä»˜æ¬¾Â·æ”¶æ®',
      typeIllegalHarmful: 'éæ³•Â·æœ‰å®³',
      typeFacilityEnvironment: 'è®¾æ–½Â·ç¯å¢ƒ',
      typeOther: 'å…¶ä»–',
      noItems: 'æ²¡æœ‰æ³¨å†Œçš„å•†å“ã€‚'
    },
    ja: {
      welcome: 'ä¼çµ±å¸‚å ´ã«ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
      title: 'ä¾¡æ ¼è¡¨',
      price: 'ä¾¡æ ¼',
      unit: 'å˜ä½',
      description: 'èª¬æ˜',
      viewCount: 'é–²è¦§æ•°',
      lastUpdated: 'æœ€çµ‚æ›´æ–°',
      reportBtn: 'ğŸš¨ å ±å‘Š',
      modalTitle: 'ğŸš¨ å•é¡Œã‚’å ±å‘Š',
      reportTypeLabel: 'å ±å‘Šã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ *',
      descriptionLabel: 'çŠ¶æ³ã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ *',
      anonymousLabel: 'åŒ¿åã§å ±å‘Š',
      nameLabel: 'ãŠåå‰',
      contactLabel: 'é€£çµ¡å…ˆ',
      submitBtn: 'é€ä¿¡',
      typePriceDisplay: 'ä¾¡æ ¼Â·è¡¨ç¤º',
      typeProductQuality: 'è£½å“Â·å“è³ª',
      typeHygieneSafety: 'è¡›ç”ŸÂ·å®‰å…¨',
      typeServiceResponse: 'ã‚µãƒ¼ãƒ“ã‚¹Â·å¯¾å¿œ',
      typePaymentReceipt: 'æ±ºæ¸ˆÂ·é ˜åæ›¸',
      typeIllegalHarmful: 'é•æ³•Â·æœ‰å®³',
      typeFacilityEnvironment: 'æ–½è¨­Â·ç’°å¢ƒ',
      typeOther: 'ãã®ä»–',
      noItems: 'ç™»éŒ²ã•ã‚ŒãŸå•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'
    }
  };


  /* ==========================================================
     URL ID ì¶”ì¶œ
     ========================================================== */
  function getPriceListId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id") || params.get("priceListId");
  }

  /* ==========================================================
     Toast
     ========================================================== */
  function showToast(msg) {
    const toast = document.getElementById("toast");
    const msgBox = document.getElementById("toast-message");
    msgBox.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 2500);
  }

  /* ==========================================================
     ì–¸ì–´ ë³€ê²½
     ========================================================== */
  function changeLanguage(lang) {
    currentLanguage = lang;

    document.querySelectorAll(".language-btn").forEach(btn => {
      btn.classList.remove("bg-[#E6A47D]", "text-white");
      btn.classList.add("bg-gray-100", "text-gray-600");
    });

    // í™œì„± ë²„íŠ¼ ìë™ ìŠ¤íƒ€ì¼ ì§€ì •
    const activeBtn = [...document.querySelectorAll(".language-btn")]
      .find(btn => btn.textContent.trim().toLowerCase().startsWith(lang));

    if (activeBtn) {
      activeBtn.classList.add("bg-[#E6A47D]", "text-white");
      activeBtn.classList.remove("bg-gray-100", "text-gray-600");
    }

    updateUIText();
    if (priceListData) renderItems(priceListData.items);
  }
  window.changeLanguage = changeLanguage;


  /* ==========================================================
     UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
     ========================================================== */
  function updateUIText() {
    const t = TRANSLATIONS[currentLanguage];

    const mapping = {
      "welcome-message": t.welcome,
      "price-list-title": t.title,
      "report-btn-text": t.reportBtn,
      "modal-title": t.modalTitle,
      "report-type-label": t.reportTypeLabel,
      "description-label": t.descriptionLabel,
      "anonymous-label": t.anonymousLabel,
      "name-label": t.nameLabel,
      "contact-label": t.contactLabel,
      "submit-btn": t.submitBtn,
      "type-price": t.typePriceDisplay,
      "type-product": t.typeProductQuality,
      "type-hygiene": t.typeHygieneSafety,
      "type-service": t.typeServiceResponse,
      "type-payment": t.typePaymentReceipt,
      "type-illegal": t.typeIllegalHarmful,
      "type-facility": t.typeFacilityEnvironment,
      "type-other": t.typeOther,
      "view-count-label": t.viewCount + ":",
      "last-updated-label": t.lastUpdated + ":"
    };

    for (let id in mapping) {
      const el = document.getElementById(id);
      if (el) el.textContent = mapping[id];
    }
  }

  /* ==========================================================
     ê°€ê²©í‘œ ë¡œë“œ
     ========================================================== */
  async function loadPriceList() {
    const priceListId = getPriceListId();
    if (!priceListId) return showError("ê°€ê²©í‘œ IDê°€ ì—†ìŠµë‹ˆë‹¤.");

    try {
      const res = await fetch(`${API_BASE}/price-list/public/${priceListId}`, {
        headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
      });

      if (!res.ok) throw new Error("ì„œë²„ì—ì„œ ê°€ê²©í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      const data = await res.json();

      let obj = data.priceList;
      if (typeof obj === "string") obj = JSON.parse(obj);

      priceListData = obj;

      document.getElementById("store-name").textContent = obj.storeName;
      document.getElementById("modal-store-name").textContent = obj.storeName;
      document.getElementById("view-count").textContent = data.viewCount || 0;
      document.getElementById("last-updated").textContent =
        new Date(obj.updatedAt).toLocaleString("ko-KR");

      renderItems(obj.items);

      document.getElementById("loading-screen").style.display = "none";
      document.getElementById("main-content").style.display = "block";

    } catch (err) {
      showError(err.message);
    }
  }

  /* ==========================================================
     ìƒí’ˆ ì¶œë ¥
     ========================================================== */
  function renderItems(items = []) {
    const container = document.getElementById("items-container");
    const t = TRANSLATIONS[currentLanguage];

    if (!items.length) {
      container.innerHTML = `
        <div class="bg-white rounded-2xl p-8 border text-center">
          <p class="text-xl text-gray-500">${t.noItems}</p>
        </div>
      `;
      return;
    }

    container.innerHTML = items.map(i => `
      <div class="bg-white rounded-2xl p-5 border-2 hover:border-[#E6A47D] transition">
        <h3 class="text-xl font-bold">${i.name}</h3>
        ${i.description ? `<p class="text-gray-500 mt-1">${t.description}: ${i.description}</p>` : ""}
        <div class="flex justify-between mt-4 border-t pt-3">
          <span class="text-gray-600">${t.unit}: ${i.unit || "ê°œ"}</span>
          <span class="text-2xl text-[#E6A47D]">${Number(i.price).toLocaleString()}ì›</span>
        </div>
      </div>
    `).join("");
  }


  /* ==========================================================
     ì˜¤ë¥˜ í™”ë©´
     ========================================================== */
  function showError(msg) {
    document.getElementById("loading-screen").style.display = "none";
    document.getElementById("error-screen").style.display = "flex";
    document.getElementById("error-message").innerHTML =
      `<p class="text-red-700">${msg}</p>`;
  }

  /* ==========================================================
     ëª¨ë‹¬ ì œì–´
     ========================================================== */
  function openReportDialog() {
    document.getElementById("report-modal").classList.add("active");
  }
  function closeReportDialog() {
    document.getElementById("report-modal").classList.remove("active");
    document.getElementById("report-form").reset();
    selectedReportType = null;

    document.querySelectorAll(".report-type-btn").forEach(el =>
      el.classList.remove("selected")
    );
  }
  window.openReportDialog = openReportDialog;
  window.closeReportDialog = closeReportDialog;

  /* ==========================================================
     ì œë³´ ìœ í˜• ì„ íƒ
     ========================================================== */
  function selectReportType(type) {
    selectedReportType = type;

    document.querySelectorAll(".report-type-btn").forEach(btn =>
      btn.classList.remove("selected")
    );

    // í´ë¦­ëœ ë²„íŠ¼ ìë™ ì°¾ì•„ì„œ ê°•ì¡°
    const btn = [...document.querySelectorAll(".report-type-btn")].find(
      b => b.getAttribute("onclick")?.includes(type)
    );

    if (btn) btn.classList.add("selected");
  }
  window.selectReportType = selectReportType;

  /* ==========================================================
     ìµëª… í† ê¸€
     ========================================================== */
  function toggleAnonymous() {
    const checked = document.getElementById("anonymous-checkbox").checked;
    document.getElementById("reporter-info").style.display = checked ? "none" : "block";
  }
  window.toggleAnonymous = toggleAnonymous;

  /* ==========================================================
     ì œë³´ ì œì¶œ
     ========================================================== */
  async function submitReport(event) {
    event.preventDefault();

    if (!selectedReportType)
      return showToast("ì œë³´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const description = document.getElementById("report-description").value.trim();
    if (!description) return showToast("ìƒí™© ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const isAnonymous = document.getElementById("anonymous-checkbox").checked;

    const reportData = {
      priceListId: priceListData.id,
      storeName: priceListData.storeName,
      storeUserId: priceListData.userId,
      reportType: selectedReportType,
      description,
      isAnonymous,
      reporterName: isAnonymous ? null : document.getElementById("reporter-name").value.trim(),
      reporterContact: isAnonymous ? null : document.getElementById("reporter-contact").value.trim(),
      userAgent: navigator.userAgent,
      timestamp: new Date().toISOString()
    };

    try {
      const res = await fetch(`${API_BASE}/report`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(reportData)
      });

      if (!res.ok) throw new Error("ì œë³´ ì œì¶œ ì‹¤íŒ¨");

      showToast("ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeReportDialog();

    } catch (err) {
      console.error(err);
      showToast("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }
  window.submitReport = submitReport;

  /* ==========================================================
     ì´ˆê¸° ì‹¤í–‰
     ========================================================== */
  updateUIText();
  loadPriceList();
});
